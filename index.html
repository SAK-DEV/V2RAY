<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>V2Ray Config Decoder</title>

  <!-- Material Design fonts and icons -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <style>
    body {
      font-family: 'Roboto', sans-serif;
      background: #f4f4f4;
      margin: 0;
      padding: 2rem;
      color: #333;
    }
    .container {
      max-width: 800px;
      margin: auto;
      background: white;
      border-radius: 12px;
      padding: 2rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    h1 {
      text-align: center;
      color: #4caf50;
    }
    form {
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    input[type="text"] {
      width: 100%;
      padding: 1rem;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 1rem;
      box-sizing: border-box;
    }
    button {
      background: #4caf50;
      color: white;
      border: none;
      padding: 0.9rem 1.2rem;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      align-self: center;
    }
    button.fetching {
      background: #ff9800;
    }
    .output {
      margin-top: 2rem;
      background: #f1f1f1;
      padding: 1rem;
      border-radius: 8px;
      cursor: pointer;
      user-select: text;
    }
    .output pre {
      margin: 0;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .qr-section {
      margin-top: 2rem;
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }
    .qr-box {
      background: #fff;
      padding: 1rem;
      border: 1px solid #ddd;
      border-radius: 8px;
      display: flex;
      align-items: center;
      gap: 1rem;
      cursor: pointer;
    }
    .qr-box img {
      width: 120px;
      height: 120px;
    }
    .qr-text {
      flex: 1;
      word-break: break-word;
    }
    .toast {
      visibility: hidden;
      min-width: 200px;
      background-color: #323232;
      color: #fff;
      text-align: center;
      border-radius: 8px;
      padding: 12px 24px;
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 14px;
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.3s ease, bottom 0.3s ease;
    }
    .toast.show {
      visibility: visible;
      opacity: 1;
      bottom: 40px;
    }
    .error-box {
      background: #ffcdd2;
      padding: 1rem;
      border-radius: 8px;
      margin-top: 1rem;
      color: #b71c1c;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>V2Ray Config Decoder</h1>

    <!-- Input field + submit button -->
    <form id="mainForm">
      <input type="text" id="urlInput" placeholder="Paste Base64 URL here..." required>
      <button type="submit" id="submitBtn">
        <span class="material-icons">cloud_download</span>
        <span id="btnText">Decode & Generate</span>
      </button>
    </form>

    <!-- Area for error message -->
    <div id="errorBox" class="error-box" style="display:none"></div>

    <!-- Area for results -->
    <div id="resultArea"></div>
  </div>

  <!-- Toast message -->
  <div id="toast" class="toast">‚úÖ Copied!</div>

  <!-- JavaScript -->
  <script>
    const form = document.getElementById("mainForm");
    const urlInput = document.getElementById("urlInput");
    const btn = document.getElementById("submitBtn");
    const btnText = document.getElementById("btnText");
    const toast = document.getElementById("toast");
    const resultArea = document.getElementById("resultArea");
    const errorBox = document.getElementById("errorBox");

    // Sanitize text: remove hidden Unicode characters like RTL markers
    function sanitize(text) {
      return text.replace(/[\u200E\u200F\u202E]/g, '');
    }

    // Decode Base64 string as UTF-8 text using TextDecoder
    function decodeBase64Utf8(base64) {
      const binary = atob(base64);
      const bytes = new Uint8Array([...binary].map(ch => ch.charCodeAt(0)));
      return new TextDecoder("utf-8").decode(bytes);
    }

    // Extract multiple configs from full block
    function extractConfigs(text) {
      const lines = text.split(/\r?\n/);
      const result = [];
      let current = "";

      for (let line of lines) {
        line = line.trim();
        if (/^(vless|vmess|trojan|ss):\/\//.test(line)) {
          if (current) result.push(current);
          current = line;
        } else {
          current += "\n" + line;
        }
      }
      if (current) result.push(current);
      return result.map(sanitize);
    }

    // Show Material-style toast message
    function showToast(msg = "‚úÖ Copied!") {
      toast.innerText = msg;
      toast.classList.add("show");
      setTimeout(() => toast.classList.remove("show"), 3000);
    }

    // Create a QR + text block for a config link
    function createQR(link, label = "") {
      const qr = document.createElement("div");
      qr.className = "qr-box";
      qr.onclick = () => navigator.clipboard.writeText(link).then(showToast);

      const a = document.createElement("a");
      a.href = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(link)}`;
      a.target = "_blank";
      a.download = "qr.png";

      const img = document.createElement("img");
      img.src = a.href;
      img.alt = "QR Code";
      a.appendChild(img);

      const text = document.createElement("div");
      text.className = "qr-text";
      text.innerText = label || link;

      qr.appendChild(a);
      qr.appendChild(text);
      return qr;
    }

    // Handle form submit and main logic
    form.onsubmit = async e => {
      e.preventDefault();
      const url = urlInput.value.trim();
      if (!url) return;

      resultArea.innerHTML = "";
      errorBox.style.display = "none";

      // Show loading state
      btn.classList.add("fetching");
      btnText.innerText = "Fetching... (click to cancel)";
      btn.onclick = () => location.reload();

      try {
        // Use public proxy to bypass CORS
        const res = await fetch("https://api.allorigins.win/get?url=" + encodeURIComponent(url));
        if (!res.ok) throw new Error("Proxy request failed");
        const json = await res.json();
        const base64 = json.contents.trim();

        // Decode with UTF-8
        const decoded = decodeBase64Utf8(base64);
        const clean = sanitize(decoded);
        const configs = extractConfigs(clean);

        // Show QR for subscription link
        const qrSub = document.createElement("div");
        qrSub.className = "qr-section";
        qrSub.onclick = () => navigator.clipboard.writeText(url).then(() => showToast("Subscription link copied!"));
        qrSub.innerHTML = `<h2>üîó Subscription Link</h2>`;
        qrSub.appendChild(createQR(url, url));
        resultArea.appendChild(qrSub);

        // Show decoded full config block
        const output = document.createElement("div");
        output.className = "output";
        output.innerHTML = `<strong>üîì Decoded Text (click to copy):</strong><pre>${clean}</pre>`;
        output.onclick = () => navigator.clipboard.writeText(clean).then(() => showToast("Config copied!"));
        resultArea.appendChild(output);

        // Show individual config QR codes
        const qrWrap = document.createElement("div");
        qrWrap.className = "qr-section";
        qrWrap.innerHTML = `<h2>üì± Config QR Codes</h2>`;
        for (let c of configs) qrWrap.appendChild(createQR(c, c));
        resultArea.appendChild(qrWrap);

      } catch (err) {
        errorBox.style.display = "block";
        errorBox.innerText = "‚ùå " + err.message;
      }

      // Reset button
      btn.classList.remove("fetching");
      btnText.innerText = "Decode & Generate";
      btn.onclick = null;
    };
  </script>
</body>
</html>
